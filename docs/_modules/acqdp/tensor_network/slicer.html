

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>acqdp.tensor_network.slicer &#8212; Alibaba Cloud Quantum Development Platform 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Alibaba Cloud Quantum Development Platform 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acqdp.tensor_network.slicer</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for acqdp.tensor_network.slicer</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">acqdp.tensor_network.local_optimizer</span> <span class="kn">import</span> <span class="n">defaultOrderResolver</span><span class="p">,</span> <span class="n">LocalOptimizer</span>
<span class="kn">from</span> <span class="nn">acqdp.tensor_network.contraction</span> <span class="kn">import</span> <span class="n">ContractionCost</span><span class="p">,</span> <span class="n">ContractionScheme</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">opt_einsum</span>
<span class="kn">import</span> <span class="nn">tqdm</span>


<div class="viewcode-block" id="Slicer"><a class="viewcode-back" href="../../../tensor_network.html#acqdp.tensor_network.Slicer">[docs]</a><span class="k">class</span> <span class="nc">Slicer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :class:`Slicer` finds slicing of an unsliced contraction scheme when called by the :class:`SlicedOrderFinder`.</span>

<span class="sd">    :ivar num_iter_before: Number of iterations of local optimization before slicing.</span>
<span class="sd">    :ivar num_iter_before: Number of iterations of local optimization in the middle of slicing.</span>
<span class="sd">    :ivar num_iter_before: Number of iterations of local optimization after slicing.</span>
<span class="sd">    :ivar max_num_slice: Maxmimum number of edges to be sliced. If set to -1, the constraint will be ignored.</span>
<span class="sd">    :ivar num_threads: Number of threads for multi-processing.</span>
<span class="sd">    :ivar slice_thres: Automatically slice edges that introduce an overhed below this threshold. Set to 0.02 by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">num_iter_before</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">num_iter_middle</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">num_iter_after</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                 <span class="n">max_tw</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span>
                 <span class="n">max_num_slice</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">num_threads</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span>
                 <span class="n">slice_thres</span><span class="o">=.</span><span class="mi">02</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_iter_before</span> <span class="o">=</span> <span class="n">num_iter_before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_iter_middle</span> <span class="o">=</span> <span class="n">num_iter_middle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_iter_after</span> <span class="o">=</span> <span class="n">num_iter_after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tw</span> <span class="o">=</span> <span class="n">max_tw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_num_slice</span> <span class="o">=</span> <span class="n">max_num_slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span> <span class="o">=</span> <span class="n">num_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_thres</span> <span class="o">=</span> <span class="n">slice_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_optimizer</span> <span class="o">=</span> <span class="n">LocalOptimizer</span><span class="p">(</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local_optimizer_params&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_suc_candidates</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_suc_candidates&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">num_process</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tnc</span> <span class="o">=</span> <span class="n">tn</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tn</span> <span class="o">=</span> <span class="n">tnc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">orders</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
                <span class="n">slice_edges</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Process </span><span class="si">{</span><span class="n">num_process</span><span class="si">}</span><span class="s1"> initial cost: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">cost</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
                    <span class="n">tn</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_iter_before</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">y</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tw</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
                        <span class="n">tn</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_iter_middle</span><span class="p">)</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_biggest_weight_edge</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
                    <span class="n">slice_edges</span> <span class="o">+=</span> <span class="n">k</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">tn</span><span class="o">.</span><span class="n">fix_edge</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">tn</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">defaultOrderResolver</span><span class="o">.</span><span class="n">order_to_contraction_scheme</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_edges</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_edges</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_slice</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">t</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tw</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="n">slice_edges</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_slice</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># early termination</span>
                        <span class="k">break</span>
                <span class="n">new_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
                    <span class="n">tn</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_iter_after</span><span class="p">)</span>
                <span class="n">new_y</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">slice_edges</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_y</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tw</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">new_y</span>
                <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tw</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Process </span><span class="si">{</span><span class="n">num_process</span><span class="si">}</span><span class="s1"> succeeded with </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">cost</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ContractionScheme</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">slice_edges</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">cost</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_biggest_weight_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find an edge or a list of edges, slicing of which introduces an overhead each that is below a threshold given by self.slice_thres, or a minimal overhead if self.slice_thres is unattainable.</span>
<span class="sd">        The method enumerates all edges that appear frequently on the stem of the contraction tree. It tries to introduce as minimal overhead as possible by flipping branches on the stem while trying to slice the edges.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tn_copy</span> <span class="o">=</span> <span class="n">tn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tn_copy</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
        <span class="n">nodes_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tn_copy</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">acqdp.tensor_network.undirected_contraction_tree</span> <span class="kn">import</span> <span class="n">UndirectedContractionTree</span>
        <span class="n">eq</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">eedd</span> <span class="o">=</span> <span class="n">defaultOrderResolver</span><span class="o">.</span><span class="n">order_to_path</span><span class="p">(</span><span class="n">tn_copy</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">uct</span> <span class="o">=</span> <span class="n">UndirectedContractionTree</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">se</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">edges_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uct</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">new_se</span> <span class="o">=</span> <span class="n">uct</span><span class="o">.</span><span class="n">open_subscripts_at_edge</span><span class="p">(</span>
                <span class="n">uct</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">uct</span><span class="o">.</span><span class="n">stem</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;parent&#39;</span><span class="p">],</span> <span class="n">uct</span><span class="o">.</span><span class="n">stem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_se</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">se</span><span class="p">):</span>
                <span class="n">edges_dic</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">se</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">new_se</span><span class="p">):</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">edges_dic</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">new_se</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">ss_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">uct</span><span class="o">.</span><span class="n">cost</span>
        <span class="n">slice_edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">:</span>
            <span class="n">uct_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">uct</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
                <span class="n">uct_copy</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;subscripts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">v</span><span class="p">][</span>
                    <span class="s1">&#39;subscripts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                <span class="n">uct_copy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">uct_copy</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">u</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">uct_copy</span><span class="o">.</span><span class="n">preprocess_edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">uct_copy</span><span class="o">.</span><span class="n">preprocess_edge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
            <span class="n">uct_copy</span><span class="o">.</span><span class="n">compute_root_cost</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">uct_copy</span><span class="o">.</span><span class="n">compute_node_cost</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">get_path</span><span class="p">())</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">curr_cost</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">while</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">ii</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ii</span><span class="p">):</span>
                            <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span> <span class="o">&lt;=</span> <span class="n">curr_cost</span><span class="p">:</span>
                            <span class="n">curr_cost</span> <span class="o">=</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span>
                            <span class="n">ii</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ii</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="n">k</span> <span class="o">=</span> <span class="n">ii</span>
                <span class="n">sss</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span> <span class="o">&lt;=</span> <span class="n">curr_cost</span><span class="p">:</span>
                        <span class="n">curr_cost</span> <span class="o">=</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span>
                        <span class="n">sss</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">sss</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ii</span><span class="p">):</span>
                    <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_cost</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">while</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">k</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                        <span class="n">ucost</span> <span class="o">=</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span>
                        <span class="k">if</span> <span class="n">ucost</span> <span class="o">&lt;=</span> <span class="n">curr_cost</span><span class="p">:</span>
                            <span class="n">curr_cost</span> <span class="o">=</span> <span class="n">ucost</span>
                            <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                                <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">jj</span>
                <span class="n">sss</span> <span class="o">=</span> <span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">ucost</span> <span class="o">=</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span>
                    <span class="k">if</span> <span class="n">ucost</span> <span class="o">&lt;=</span> <span class="n">curr_cost</span><span class="p">:</span>
                        <span class="n">curr_cost</span> <span class="o">=</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">cost</span>
                        <span class="n">sss</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">jj</span> <span class="o">=</span> <span class="n">sss</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uct_copy</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">uct_copy</span><span class="o">.</span><span class="n">switch_branches</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">jj</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">jj</span>
            <span class="k">if</span> <span class="n">curr_cost</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_thres</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">slice_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eedd</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">curr_cost</span>
                <span class="n">uct</span> <span class="o">=</span> <span class="n">uct_copy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ss_dic</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_cost</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">uct_copy</span><span class="o">.</span><span class="n">get_path</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">uct</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ss_dic</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ss_dic</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">slice_edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">eedd</span><span class="p">[</span><span class="n">kk</span><span class="p">]]</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">ss_dic</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pp</span><span class="p">):</span>
            <span class="n">new_order</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">nodes_names</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">nodes_names</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span> <span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">nodes_names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">nodes_names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">nodes_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">slice_edges</span><span class="p">,</span> <span class="n">new_order</span>

    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">order_gen</span><span class="p">):</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">order_gen</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_suc_candidates</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slice</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">mpwrapper</span><span class="p">(</span><span class="n">slicer</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">num_process</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">slicer</span><span class="o">.</span><span class="n">_slice</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">num_process</span><span class="p">)</span>


<div class="viewcode-block" id="MPSlicer"><a class="viewcode-back" href="../../../tensor_network.html#acqdp.tensor_network.MPSlicer">[docs]</a><span class="k">class</span> <span class="nc">MPSlicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-processing slicing, by concurrently trying different slicing routes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">order_gen</span><span class="p">):</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_suc_candidates</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">lk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">order_gen</span><span class="p">)],</span> <span class="n">num_process</span><span class="p">)</span> <span class="k">for</span> <span class="n">num_process</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_threads</span><span class="p">))</span>
                <span class="n">new_candidates</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">mpwrapper</span><span class="p">,</span> <span class="n">lk</span><span class="p">)</span>
            <span class="n">candidates</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_candidates</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Num of candidates now: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">candidates</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">res</span></div>


<span class="k">def</span> <span class="nf">get_slicer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">slicers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">Slicer</span><span class="p">,</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span> <span class="n">MPSlicer</span><span class="p">}</span>
    <span class="n">slicer_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slicer_name&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">slicers</span><span class="p">[</span><span class="n">slicer_name</span><span class="p">])(</span><span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slicer_params&#39;</span><span class="p">,</span> <span class="p">{}))</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Alibaba Cloud Quantum Development Platform 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">acqdp.tensor_network.slicer</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Alibaba Quantum Laboratory.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>